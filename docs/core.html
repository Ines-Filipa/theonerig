---

title: Title
keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DataChunk" class="doc_header"><code>class</code> <code>DataChunk</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/core.py#L15" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DataChunk</code>(<strong><code>data</code></strong>, <strong><code>idx</code></strong>, <strong><code>group</code></strong>, <strong><code>fill</code></strong>=<em><code>0</code></em>) :: <code>ndarray</code></p>
</blockquote>
<p>Base brick of data.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ContiguousRecord" class="doc_header"><code>class</code> <code>ContiguousRecord</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/core.py#L53" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ContiguousRecord</code>(<strong><code>length</code></strong>:<code>int</code>, <strong><code>signals</code></strong>:<a href="/core.html#DataChunk"><code>DataChunk</code></a>, <strong><code>main_tp</code></strong>:<a href="/core.html#DataChunk"><code>DataChunk</code></a>)</p>
</blockquote>
<p>Representation of a contiguous recording session to store DataChunk
of various sources under a single time reference. DataChunk are stored
under a name in one of the groups "sync","stim","data" and "cell".</p>
<p>A name can contain multiple DataChunk if those are not overlapping in time.</p>
<p>Each ContiguousRecord contains in the group "sync" two master DataChunk,
one for signals to be recorded across acquisition device to syncronize them,
one for timepoints of these signals for the main device and are called
respectively "signals" and "main_tp".</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RecordMaster" class="doc_header"><code>class</code> <code>RecordMaster</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/core.py#L167" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RecordMaster</code>(<strong><code>reference_data_list</code></strong>:<code>Sequence</code>[<code>Tuple</code>[<a href="/core.html#DataChunk"><code>DataChunk</code></a>, <a href="/core.html#DataChunk"><code>DataChunk</code></a>]], <strong><code>frame_time</code></strong>=<em><code>0.016666666666666666</code></em>, <strong><code>sep_size</code></strong>=<em><code>1000</code></em>) :: <code>list</code></p>
</blockquote>
<p>One Timeserie to rule them all, One Timeserie to find them,
One Timeserie to bring them all and in the darkness bind them</p>
<p>The RecordMaster class is the top level object managing all
timeseries. It uses a list of ContiguousRecord to represent
possible discontinuted data records.</p>
<p>The main aim of the RecordMaster is to store the various data
stream of an experiment under a unique time reference, to ease
the processing of the data.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Data_Pipe" class="doc_header"><code>class</code> <code>Data_Pipe</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/core.py#L280" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Data_Pipe</code>(<strong><code>record_master</code></strong>:<a href="/core.html#RecordMaster"><code>RecordMaster</code></a>, <strong><code>data_names</code></strong>:<code>Union</code>[<code>str</code>, <code>list</code>], <strong><code>target_names</code></strong>:<code>Union</code>[<code>str</code>, <code>list</code>]=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Some testing of the lib</span>
<span class="kn">from</span> <span class="nn">nbdev.test</span> <span class="k">import</span> <span class="n">test_eq</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1">#Load all the test data</span>
<span class="kn">from</span> <span class="nn">theonerig.testdata</span> <span class="k">import</span> <span class="o">*</span>
<span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">load_vivo_2p</span><span class="p">())</span>

<span class="c1">#Few tests on the shape of the data</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">S_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">49000</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">len_records</span><span class="p">),</span> <span class="n">S_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">eye_TP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eye_DATA</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">proj_TP</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">proj_DATA</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Returning stim_d, S_matrix, A_matrix, proj_TP, proj_DATA, eye_TP, eye_DATA, treadm_DATA, len_records, rec_TP, reM
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">theonerig.utils</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1">#Extending the main timepoints to left and right to cover the whole duration of the record</span>
<span class="n">timepoints_chunkD</span><span class="p">,</span> <span class="n">signals_chunkD</span><span class="p">,</span> <span class="n">n_left</span> <span class="o">=</span> <span class="n">extend_sync_timepoints</span><span class="p">(</span><span class="n">proj_TP</span><span class="p">,</span> <span class="n">proj_DATA</span><span class="p">,</span> <span class="n">up_bound</span><span class="o">=</span><span class="n">proj_TP</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">100000</span><span class="p">)</span>
<span class="n">reM</span> <span class="o">=</span> <span class="n">RecordMaster</span><span class="p">([(</span><span class="n">timepoints_chunkD</span><span class="p">,</span> <span class="n">signals_chunkD</span><span class="p">)])</span>

<span class="c1">#Downsample the treadmill acquired at 10kHz to 60Hz.</span>
<span class="n">treadm_chunkD</span> <span class="o">=</span> <span class="n">resample_to_timepoints</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">treadm_DATA</span><span class="p">))),</span><span class="n">treadm_DATA</span><span class="p">,</span> <span class="n">timepoints_chunkD</span><span class="p">)</span>
<span class="n">reM</span><span class="o">.</span><span class="n">set_datachunk</span><span class="p">(</span><span class="n">dc</span><span class="o">=</span><span class="n">treadm_chunkD</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;treadmill&quot;</span><span class="p">)</span>

<span class="c1">#Upsample the eye tracking acquired at 15Hz to 60Hz.</span>
<span class="n">eye_upsamp</span> <span class="o">=</span> <span class="n">resample_to_timepoints</span><span class="p">(</span><span class="n">eye_TP</span><span class="p">,</span> <span class="n">eye_DATA</span><span class="p">,</span> <span class="n">timepoints_chunkD</span><span class="p">)</span>
<span class="n">reM</span><span class="o">.</span><span class="n">set_datachunk</span><span class="p">(</span><span class="n">dc</span><span class="o">=</span><span class="n">eye_upsamp</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;eye_tracking&quot;</span><span class="p">)</span>

<span class="c1">#Iterating over the record lengths to create all datachunk</span>
<span class="n">cursor</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">len_record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">len_records</span><span class="p">):</span>
    <span class="n">resampled_dataChunk</span> <span class="o">=</span> <span class="n">resample_to_timepoints</span><span class="p">(</span><span class="n">timepoints</span> <span class="o">=</span> <span class="n">rec_TP</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">len_record</span><span class="p">],</span>
                           <span class="n">data</span> <span class="o">=</span> <span class="n">S_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">cursor</span><span class="p">:</span><span class="n">cursor</span><span class="o">+</span><span class="n">len_record</span><span class="p">],</span>
                           <span class="n">ref_timepoints</span> <span class="o">=</span> <span class="n">timepoints_chunkD</span><span class="p">,</span>
                           <span class="n">group</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">+=</span> <span class="n">len_record</span>
    <span class="n">reM</span><span class="o">.</span><span class="n">set_datachunk</span><span class="p">(</span><span class="n">dc</span><span class="o">=</span><span class="n">resampled_dataChunk</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;S_matrix&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">stim_key</span> <span class="ow">in</span> <span class="n">stim_d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">stim_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stim_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="c1">#Stim data are in the timing of the main sync, no need for resampling</span>
    <span class="n">reM</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DataChunk</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">stim_d</span><span class="p">[</span><span class="n">stim_key</span><span class="p">],</span> <span class="n">idx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">,</span><span class="n">group</span><span class="o">=</span><span class="s2">&quot;stim&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pipe_1</span> <span class="o">=</span> <span class="n">Data_Pipe</span><span class="p">(</span><span class="n">reM</span><span class="p">,</span> <span class="n">data_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;S_matrix&quot;</span><span class="p">,</span> <span class="s2">&quot;treadmill&quot;</span><span class="p">],</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spike_counts&quot;</span><span class="p">,</span> <span class="s2">&quot;treadmill&quot;</span><span class="p">])</span>
<span class="n">pipe_1</span> <span class="o">+=</span> <span class="s2">&quot;S_matrix&quot;</span> <span class="c1">#We can +,-,&amp;,| symbols to add masks to the pipe</span>
<span class="n">pipe_1</span> <span class="o">-=</span> <span class="s2">&quot;stim&quot;</span>     <span class="c1">#Name of a group can be use instead of individual DataChunk</span>

<span class="n">pipe_2</span> <span class="o">=</span> <span class="n">Data_Pipe</span><span class="p">(</span><span class="n">reM</span><span class="p">,</span> <span class="n">data_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;S_matrix&quot;</span><span class="p">,</span> <span class="s2">&quot;treadmill&quot;</span><span class="p">],</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;spike_counts&quot;</span><span class="p">,</span> <span class="s2">&quot;treadmill&quot;</span><span class="p">])</span>
<span class="n">pipe_2</span> <span class="o">+=</span> <span class="s2">&quot;darkness&quot;</span> <span class="c1">#We can +,-,&amp;,| symbols to add masks to the pipe</span>
<span class="n">pipe_2</span> <span class="o">&amp;=</span> <span class="s2">&quot;S_matrix&quot;</span>     <span class="c1">#Name of a group can be use instead of individual DataChunk</span>

<span class="n">reM</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">pipe_1</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> <span class="c1">#Plotting the pipe after plotting its recordMaster reference will add it to the plot</span>
<span class="n">pipe_2</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span> <span class="c1">#pipe_1 and pipe_2 appear respectively blue and orange on the plot</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Pipe can be iterated, or indexed to get the dictionnary of the epochs seen by masking</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pipe_1</span><span class="p">),</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pipe_2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pipe_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="p">[</span><span class="s2">&quot;spike_counts&quot;</span><span class="p">,</span> <span class="s2">&quot;treadmill&quot;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pipe_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="p">[</span><span class="s2">&quot;spike_counts&quot;</span><span class="p">,</span> <span class="s2">&quot;treadmill&quot;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipe 1 shapes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">data_d</span><span class="p">[</span><span class="s2">&quot;spike_counts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">data_d</span> <span class="ow">in</span> <span class="n">pipe_1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipe 2 shapes&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">data_d</span><span class="p">[</span><span class="s2">&quot;spike_counts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">data_d</span> <span class="ow">in</span> <span class="n">pipe_2</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="export_record" class="doc_header"><code>export_record</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/core.py#L442" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>export_record</code>(<strong><code>_path</code></strong>, <strong><code>record_master</code></strong>)</p>
</blockquote>
<p>Export a Record_Master object to an h5 file, readable outside of this library.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="import_record" class="doc_header"><code>import_record</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/core.py#L464" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>import_record</code>(<strong><code>_path</code></strong>)</p>
</blockquote>
<p>Import a Record_Master from an h5 file saved by the export_record function of this library.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="n">export_record</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">vivo_2p_dir</span><span class="p">,</span> <span class="s2">&quot;record_master.h5&quot;</span><span class="p">),</span> <span class="n">reM</span><span class="p">)</span>
<span class="n">reM_loaded</span> <span class="o">=</span> <span class="n">import_record</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">vivo_2p_dir</span><span class="p">,</span> <span class="s2">&quot;record_master.h5&quot;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reM</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">reM_loaded</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.utils</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">notebook2script</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

