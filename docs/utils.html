---

title: Utils
keywords: fastai
sidebar: home_sidebar

summary: "Useful functiosn to reshape/arrange/reduce raw data into clean data to add to the record"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.test</span> <span class="k">import</span> <span class="n">test_eq</span>
<span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extend_sync_timepoints" class="doc_header"><code>extend_sync_timepoints</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extend_sync_timepoints</code>(<strong><code>timepoints</code></strong>:<code>ndarray</code>, <strong><code>signals</code></strong>:<code>ndarray</code>, <strong><code>up_bound</code></strong>, <strong><code>low_bound</code></strong>=<em><code>0</code></em>)</p>
</blockquote>
<p>From <code>timepoints</code> and <code>signals</code> list, extend it on the left so it includes <code>low_bound</code>, and extend it
up to <code>up_bound</code>.
Return the new timepoints and signals as DataChunk objets with the number of timepoints added to the left
as a tuple.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It extends the timepoints by finding the typical distance between timepoints so it includes both left and right limits.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">extended_tp</span><span class="p">,</span> <span class="n">extended_sig</span><span class="p">,</span> <span class="n">n_left</span> <span class="o">=</span> <span class="n">extend_sync_timepoints</span><span class="p">([</span><span class="mi">7900</span><span class="p">,</span><span class="mi">8900</span><span class="p">,</span><span class="mi">9900</span><span class="p">],</span> <span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">up_bound</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">extended_tp</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">extended_sig</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;N timepoints added to the left:&quot;</span><span class="p">,</span><span class="n">n_left</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="align_sync_timepoints" class="doc_header"><code>align_sync_timepoints</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L42" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>align_sync_timepoints</code>(<strong><code>timepoints</code></strong>:<code>ndarray</code>, <strong><code>signals</code></strong>:<code>ndarray</code>, <strong><code>ref_timepoints</code></strong>:<a href="/core.html#DataChunk"><code>DataChunk</code></a>, <strong><code>ref_signals</code></strong>:<a href="/core.html#DataChunk"><code>DataChunk</code></a>, <strong><code>shift</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Align the <code>signals</code> of a <code>timepoints</code> timeserie to a reference <code>ref_timepoints</code> with the corresponding
<code>ref_signals</code>. A <code>shift</code> can be directly specified, otherwise it will be searched by finding the maximum
of the correlations of the two signals timeseries.
Returns a DataChunk of the aligned timepoints</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Aligning these signals 1,2,3 to the previously extended timepoints and signals</span>
<span class="n">aligned_timepoints</span> <span class="o">=</span> <span class="n">align_sync_timepoints</span><span class="p">(</span><span class="n">timepoints</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span><span class="mi">2000</span><span class="p">,</span><span class="mi">3000</span><span class="p">],</span> <span class="n">signals</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                     <span class="n">ref_timepoints</span><span class="o">=</span><span class="n">extended_tp</span><span class="p">,</span> <span class="n">ref_signals</span><span class="o">=</span><span class="n">extended_sig</span><span class="p">)</span>

<span class="c1">#We can observe 8 timepoints added to our function to match all existing frame of the reference.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">aligned_timepoints</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aligned_timepoints</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">extended_tp</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="resample_to_timepoints" class="doc_header"><code>resample_to_timepoints</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L74" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>resample_to_timepoints</code>(<strong><code>timepoints</code></strong>:<code>ndarray</code>, <strong><code>data</code></strong>:<code>ndarray</code>, <strong><code>ref_timepoints</code></strong>:<a href="/core.html#DataChunk"><code>DataChunk</code></a>, <strong><code>group</code></strong>=<em><code>'data'</code></em>)</p>
</blockquote>
<p>Resample the <code>data</code> at the <code>timepoints</code> to an array at the timepoints of <code>ref_timepoints</code>.
Return a DataChunck of the resampled data belonging to <code>group</code>.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#Downsampling</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">len_data</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">wrong_dim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">len_data</span><span class="p">)</span>
<span class="n">wrong_dim_timepoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="n">len_data</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="n">downsamp_data</span> <span class="o">=</span> <span class="n">resample_to_timepoints</span><span class="p">(</span><span class="n">wrong_dim_timepoints</span><span class="p">,</span> <span class="n">wrong_dim_data</span><span class="p">,</span> 
                                         <span class="n">ref_timepoints</span><span class="o">=</span><span class="n">extended_tp</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wrong_dim_timepoints</span><span class="p">,</span> <span class="n">wrong_dim_data</span><span class="p">)</span>
<span class="n">start</span><span class="p">,</span><span class="n">stop</span> <span class="o">=</span> <span class="n">downsamp_data</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">downsamp_data</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">downsamp_data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">extended_tp</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">downsamp_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orig len:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrong_dim_data</span><span class="p">),</span> <span class="s2">&quot;Target len:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">extended_tp</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Upsampling</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">len_data</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">wrong_dim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">len_data</span><span class="p">)</span>
<span class="n">wrong_dim_timepoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="n">len_data</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="n">downsamp_data</span> <span class="o">=</span> <span class="n">resample_to_timepoints</span><span class="p">(</span><span class="n">wrong_dim_timepoints</span><span class="p">,</span> <span class="n">wrong_dim_data</span><span class="p">,</span> 
                                         <span class="n">ref_timepoints</span><span class="o">=</span><span class="n">extended_tp</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wrong_dim_timepoints</span><span class="p">,</span> <span class="n">wrong_dim_data</span><span class="p">)</span>
<span class="n">start</span><span class="p">,</span><span class="n">stop</span> <span class="o">=</span> <span class="n">downsamp_data</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">downsamp_data</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">downsamp_data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">extended_tp</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">],</span> <span class="n">downsamp_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orig len:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrong_dim_data</span><span class="p">),</span> <span class="s2">&quot;Target len:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">extended_tp</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="stim_to_dataChunk" class="doc_header"><code>stim_to_dataChunk</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L99" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>stim_to_dataChunk</code>(<strong><code>stim_values</code></strong>, <strong><code>stim_start_idx</code></strong>, <strong><code>reference</code></strong>:<a href="/core.html#DataChunk"><code>DataChunk</code></a>)</p>
</blockquote>
<p>Factory function for DataChunk of a stimulus</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="spike_to_dataChunk" class="doc_header"><code>spike_to_dataChunk</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L104" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>spike_to_dataChunk</code>(<strong><code>spike_timepoints</code></strong>, <strong><code>ref_timepoints</code></strong>:<a href="/core.html#DataChunk"><code>DataChunk</code></a>)</p>
</blockquote>
<p><code>spike_timepoints</code> must be a dictionnary of cell spike_timepoints list. This function then
bins the</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parse_stim_args" class="doc_header"><code>parse_stim_args</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L122" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parse_stim_args</code>(<strong><code>stim_name</code></strong>, <strong><code>stim_ref</code></strong>)</p>
</blockquote>
<p>Function really specific to Asari Lab stimuli. Stimuli were stored as h5 files. This function parse
the attributes of the stimuli that were stored in the h5 references of the stimuli.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="peak_sta_frame" class="doc_header"><code>peak_sta_frame</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L145" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>peak_sta_frame</code>(<strong><code>sta</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="stim_inten_norm" class="doc_header"><code>stim_inten_norm</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L150" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>stim_inten_norm</code>(<strong><code>stim_inten</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="twoP_dataChunks" class="doc_header"><code>twoP_dataChunks</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L161" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>twoP_dataChunks</code>(<strong><code>ref_timepoints</code></strong>:<a href="/core.html#DataChunk"><code>DataChunk</code></a>, <strong><code>frame_timepoints</code></strong>, <strong><code>len_epochs</code></strong>, <strong><code>C_matrix</code></strong>, <strong><code>S_matrix</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="img_2d_fit" class="doc_header"><code>img_2d_fit</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L181" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>img_2d_fit</code>(<strong><code>shape</code></strong>, <strong><code>param_d</code></strong>, <strong><code>f</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="fill_nan" class="doc_header"><code>fill_nan</code><a href="https://github.com/Tom-TBT/theonerig/tree/master/theonerig/utils.py#L187" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fill_nan</code>(<strong><code>A</code></strong>)</p>
</blockquote>
<p>interpolate to fill nan values. BRYAN WOODS@StackOverflow</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">notebook2script</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

